{% extends "base.html" %}

{% block content %}
    <h1>中医诊断系统</h1>
    {% if current_user.is_authenticated %}
        <form id="prescriptionForm">
            <div class="mb-3">
                <label for="prescription" class="form-label">请输入处方（用逗号分隔中药名）：</label>
                <input type="text" class="form-control" id="prescription" name="prescription" required>
            </div>
            <button type="submit" class="btn btn-primary">诊断</button>
        </form>
        <div id="result" class="mt-4"></div>
    {% else %}
        <p>请<a href="{{ url_for('auth.login') }}">登录</a>或<a href="{{ url_for('auth.register') }}">注册</a>以使用诊断系统。</p>
    {% endif %}
{% endblock %}

{% block scripts %}
    {% if current_user.is_authenticated %}
        <script>
            document.getElementById('prescriptionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const prescription = document.getElementById('prescription').value;
                axios.post('{{ url_for("diagnosis.diagnose") }}', {
                    prescription: prescription
                }, {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                })
                .then(function (response) {
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = '<h2>诊断结果：</h2>';
                    response.data.forEach(function(disease) {
                        resultDiv.innerHTML += `<p>${disease.name}: ${(disease.probability * 100).toFixed(2)}%</p>`;
                    });
                })
                .catch(function (error) {
                    console.error(error);
                });
            });
        </script>
    {% endif %}
{% endblock %}